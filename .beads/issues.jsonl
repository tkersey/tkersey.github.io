{"id":"blog-0yg","title":"Zig static blog for GitHub Pages (minimal)","description":"Built a minimal static blog generator in Zig 0.15.2 for https://tkersey.github.io.\n\nOutcome:\n- Markdown posts in `posts/` with YAML front matter (`title`, `date`; optional `description`, `tags`, `draft`, `slug`).\n- Generates `dist/` containing `index.html`, per-post `\u003cslug\u003e.html`, `feed.xml` (RSS 2.0), and copied `static/` assets.\n- Reads `site.yml` for site metadata and directory names.\n- `zig build serve` serves `dist/` and rebuilds on changes (portable polling watcher).\n- Generator hardens safety invariants (output-dir validation/containment, symlink-safe cleanup, overlap checks, atomic writes).\n\nWhere:\n- Build + wiring: `build.zig`, `build.zig.zon`\n- CLI/server/generator: `src/*.zig`\n- Site config + content: `site.yml`, `posts/`, `static/`\n- CI + Pages deploy: `.github/workflows/ci.yml`, `.github/workflows/pages.yml`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","design":"Decisions + rationale:\n- Keep the toolchain minimal and host-native: the generator is a Zig 0.15.2 host tool invoked via `zig build`.\n- Front matter parsing is a small, line-based YAML subset tailored to posts (scalars + tags lists), with strict `YYYY-MM-DD` dates and owned parsed buffers to avoid slice lifetime footguns.\n- Use `cmark-gfm` (via `kristoff-it/cmark-gfm`) for pragmatic GFM-ish Markdown rendering; keep it safe by default (no raw HTML / dangerous URLs) and validate UTF-8 at the renderer boundary.\n- Prefer deterministic and portable output: stable post ordering, minimal built-in template, and relative URLs so output works under `file://` and subpath deployments.\n- Treat `dist/` as a generated tree with a high blast radius:\n  - validate output directories before cleanup (reject empty/\".\"/absolute/`..`/escaping base dir)\n  - cleanup never follows symlinks\n  - reject overlapping `static_dir`/`dist_dir`\n  - write generated artifacts via atomic replace to avoid truncated responses during rebuilds.\n- Local preview prioritizes safety and correctness: bounded serving, safe path handling, and a portable polling watcher with a robust fingerprint and bounded poll interval.\n- CI and deploy are least-privilege and constrained:\n  - fmt/test/build in CI\n  - Pages deploy gated on `main` pushes and pinned runner images.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build` (produces `dist/index.html` + per-post pages + `dist/feed.xml`)\n- Manual: `zig build serve`, edit a file under `posts/` or `static/` or `site.yml`, and observe a rebuild.","notes":"Closure Notes\n- Outcome:\n  - Built a minimal Zig-powered blog generator + preview server with configurable inputs (`site.yml`) and deterministic HTML/RSS output.\n  - Hardened generator and preview invariants to remove deletion/serving/watch footguns.\n  - Added CI (fmt/test/build) and GitHub Pages deployment from `main` without committing generated output.\n- Key learnings:\n  - Zig 0.15 build/test roots can pull transitive imports; linking C deps (cmark) must cover those roots.\n  - For deletion safety, lexical path checks are not enough; `realpath` containment matters (symlinks).\n- Decisions + rationale:\n  - Choose `cmark-gfm` for correctness + GFM-ish features while keeping rendering safe by default.\n  - Enforce output-dir safety in the generator layer because it owns cleanup.\n- Constraints / invariants discovered:\n  - Never allow `dist_dir` to resolve to (or escape) the base directory.\n  - `dist/` cleanup must not follow symlinks.\n  - `static_dir` and `dist_dir` must be disjoint.\n  - Markdown/RSS inputs must be valid UTF-8; RSS output must be valid XML 1.0.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig` (pass)\n  - `zig build test` (pass)\n  - `zig build` (pass; emits \"Generated site in dist/\")\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Files / symbols touched:\n  - `README.md`\n  - `build.zig`, `build.zig.zon`\n  - `src/cli.zig`, `src/site.zig`, `src/server.zig`, `src/watch.zig`\n  - `src/front_matter.zig`, `src/markdown.zig`, `src/scalars.zig`\n  - `.github/workflows/ci.yml`, `.github/workflows/pages.yml`\n- External refs (PR/commit/issues): blog-0yg (PR TBD)\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: zig static blog, site.yml config, cmark-gfm, rss feed.xml, safe dist cleanup, watcher fingerprint","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2025-12-13T12:56:22.878632-08:00","updated_at":"2025-12-13T22:53:59.635385-08:00","labels":["memory","runbook"]}
{"id":"blog-0yg.1","title":"Repo + config skeleton","description":"Add baseline repo files (README, .gitignore), site.yml schema, and expected directories (posts/, static/, dist/).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:57:59.247225-08:00","updated_at":"2025-12-13T13:08:14.205062-08:00","closed_at":"2025-12-13T13:08:14.205062-08:00","dependencies":[{"issue_id":"blog-0yg.1","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.247696-08:00","created_by":"daemon"}]}
{"id":"blog-0yg.2","title":"Zig project scaffold + CLI","description":"Scaffold the Zig 0.15.2 project and build/serve workflow.\n\n- Adds `blog` executable with `build` and `serve` subcommands.\n- `zig build` (default) generates placeholder HTML into `dist/` from `posts/*.md`.\n- `zig build serve` serves `dist/` locally (no watch/rebuild yet).\n\nWhere:\n- `build.zig`, `build.zig.zon`\n- `src/main.zig`, `src/cli.zig`, `src/site.zig`, `src/server.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"- Zig 0.15 build system uses `root_module`; create a private module via `b.createModule` and pass it to `b.addExecutable`/`b.addTest`.\n- Make `zig build` generate `dist/` by setting `b.default_step` to a run step that invokes `blog build`.\n- Implement a minimal `blog serve` HTTP file server using `std.net` + `std.http.Server`, with basic path traversal protection.\n- Keep generated output git-clean by writing under `dist/` (which already contains its own `.gitignore`).","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build` generates `dist/index.html`\n- `zig build test`\n- `zig build serve` starts a server on http://127.0.0.1:8080 (or custom host/port via `blog serve --host/--port`)","notes":"Closure Notes\n- Outcome: Zig project scaffolded with `blog` CLI + `zig build` steps; `zig build` generates placeholder pages into `dist/`, and `zig build serve` serves `dist/` locally.\n- Key learnings: Zig 0.15 uses `zig init` (no `zig init-exe`) and build definitions require `root_module`/`createModule`.\n- Decisions + rationale: Set `b.default_step` to site generation so `zig build` produces the artifact; keep `serve` minimal (no watch) but safe against `..` traversal.\n- Constraints / invariants discovered: `dist/` is generated; preserve `dist/.gitignore`; only serve files under `dist/`.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Commands run (copy/paste safe):\n  - `zig build`\n  - `zig build test`\n  - `zig fmt build.zig src/*.zig`\n- Files / symbols touched:\n  - `build.zig`\n  - `build.zig.zon`\n  - `src/main.zig` (`main`)\n  - `src/cli.zig` (`run`)\n  - `src/site.zig` (`generate`)\n  - `src/server.zig` (`serve`)\n  - `README.md`\n  - `.gitignore`\n- External refs (PR/commit/issues): blog-0yg.2\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: zig 0.15 root_module createModule addExecutable, std.http.Server static file server","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-13T12:57:59.297244-08:00","updated_at":"2025-12-13T13:40:18.318286-08:00","closed_at":"2025-12-13T13:40:18.318286-08:00","labels":["decision","memory","runbook"],"dependencies":[{"issue_id":"blog-0yg.2","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.297647-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.2","depends_on_id":"blog-0yg.1","type":"blocks","created_at":"2025-12-13T12:57:59.669163-08:00","created_by":"daemon"}]}
{"id":"blog-0yg.3","title":"Pick + integrate Markdown renderer","description":"Pick and integrate a Markdown renderer for Zig 0.15.2.\n\nOutcome:\n- Integrated `cmark-gfm` (GitHub Flavored Markdown) via the Zig package `kristoff-it/cmark-gfm`.\n- Added `src/markdown.zig` to render Markdown to an HTML fragment with core GFM extensions enabled (table, strikethrough, autolink, tasklist, tagfilter).\n- Updated `src/site.zig` to render post bodies as HTML (instead of HTML-escaped `\u003cpre\u003e`), wrapped in `\u003cmain\u003e`.\n\nWhere:\n- `build.zig.zon` (dependency)\n- `build.zig` (link `cmark-gfm` + `cmark-gfm-extensions`)\n- `src/markdown.zig`\n- `src/site.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"Decisions + rationale:\n- Chose `cmark-gfm` via `kristoff-it/cmark-gfm` as the smallest pragmatic path to GFM-ish output on Zig 0.15.x: it provides the upstream GFM extension set and builds cleanly with the current Zig build API.\n- Kept rendering safe by default (do not enable `CMARK_OPT_UNSAFE`): raw HTML and dangerous URLs remain scrubbed.\n- Enabled the core extensions needed for “GFM-ish”: tables, strikethrough, autolink, task lists (plus tagfilter).\n\nAlternatives considered:\n- Zig-native renderers (e.g. koino) were attempted but their build/dependency stack currently targets an older Zig build API and did not compile on Zig 0.15.2.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`\n- The site generator emits rendered HTML for post bodies (table/strikethrough/autolink/tasklist supported).","notes":"Closure Notes\n- Outcome:\n  - Switched the generator from “escape markdown into \u003cpre\u003e” to real Markdown-\u003eHTML rendering using `cmark-gfm` with core GFM extensions.\n- Key learnings:\n  - Some Zig-native Markdown libs lag Zig 0.15’s build API; `kristoff-it/cmark-gfm` is a stable, low-dependency fallback that still delivers GFM features.\n- Decisions + rationale:\n  - Prefer a C reference implementation (cmark-gfm) for correctness/compatibility; keep output safe by default by not enabling `CMARK_OPT_UNSAFE`.\n- Constraints / invariants discovered:\n  - Extension registration must happen before attaching extensions (`cmark_gfm_core_extensions_ensure_registered`).\n  - Render output returned from cmark must be freed with cmark’s default allocator.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Commands run (copy/paste safe):\n  - `zig fetch --save git+https://github.com/kristoff-it/cmark-gfm.git`\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Files / symbols touched:\n  - `build.zig`\n  - `build.zig.zon`\n  - `src/markdown.zig` (`renderHtml`)\n  - `src/site.zig` (`generatePostPage` now renders Markdown)\n- External refs (PR/commit/issues): blog-0yg.3; PR #4\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: cmark-gfm zig build.zig.zon, markdown renderer gfm extensions, CMARK_OPT_UNSAFE safe mode","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:57:59.347885-08:00","updated_at":"2025-12-13T16:00:21.488326-08:00","closed_at":"2025-12-13T16:00:21.488326-08:00","external_ref":"gh-4","labels":["decision","memory"],"dependencies":[{"issue_id":"blog-0yg.3","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.348372-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.3","depends_on_id":"blog-0yg.2","type":"blocks","created_at":"2025-12-13T12:57:59.699619-08:00","created_by":"daemon"}]}
{"id":"blog-0yg.4","title":"Parse YAML front matter","description":"Implement YAML front matter extraction + parsing for posts and integrate it into site generation.\n\nOutcome:\n- `site.generate` parses leading `---` front matter and uses `title` for page/index titles.\n- Required fields: `title`, `date` (ISO `YYYY-MM-DD`); optional: `description`, `tags`, `draft`, `slug`.\n- Draft posts (`draft: true`) are skipped during generation.\n- Output filenames use the provided `slug` (if present) or filename stem, normalized via existing `slugify`.\n\nWhere:\n- `src/front_matter.zig`\n- `src/site.zig`\n- `build.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"- Avoided a full YAML dependency: implemented a small, line-based parser supporting `key: value`, `tags:` block lists (`- item`), and simple inline lists (`tags: [a, b]`).\n- Front matter is required; missing delimiters or required keys fails fast.\n- Parsed dates into a small `Date` struct (YYYY-MM-DD) to support later sorting/feed generation.\n- Reused `slugify` to sanitize user-provided `slug` values and keep output filenames safe.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build` generates `dist/index.html` using front matter titles\n- `zig build test`\n- Draft posts (`draft: true`) do not appear in `dist/index.html`","notes":"Closure Notes\n- Outcome:\n  - Added YAML front matter parser + tests and integrated it into generation.\n  - Generator now requires `title` + `date`, parses optional `description/tags/draft/slug`, and skips drafts.\n- Key learnings:\n  - A simple, purpose-built parser is enough for the constrained front matter subset we need right now.\n- Decisions + rationale:\n  - Keep the YAML subset intentionally small to avoid extra deps until the Markdown renderer choice lands.\n  - Parse date eagerly to a comparable struct for future sort/feed work.\n- Constraints / invariants discovered:\n  - Posts must begin with `---` front matter and include `title` + `date`.\n  - Slugs must be normalized/sanitized before becoming output filenames.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Files / symbols touched:\n  - `src/front_matter.zig` (`parse`, `splitFrontMatter`, `FrontMatter`, `Date`)\n  - `src/site.zig` (`generate` now uses front matter; draft skipping)\n  - `build.zig` (include `src/front_matter.zig` in `zig build test`)\n- External refs (PR/commit/issues): blog-0yg.4; PR #3; commit 10c04f3\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: front matter parser, YAML subset, tags list, draft true skip, ISO date parse","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:57:59.397194-08:00","updated_at":"2025-12-13T14:21:02.667631-08:00","closed_at":"2025-12-13T14:21:02.667631-08:00","external_ref":"gh-3","dependencies":[{"issue_id":"blog-0yg.4","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.397653-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.4","depends_on_id":"blog-0yg.2","type":"blocks","created_at":"2025-12-13T12:57:59.73081-08:00","created_by":"daemon"}]}
{"id":"blog-0yg.5","title":"Generate HTML pages","description":"Generate `index.html` and per-post `/\u003cslug\u003e.html` pages with a minimal, consistent template and root-relative links suitable for the root GitHub Pages URL.\n\nOutcome:\n- `dist/index.html` is a full HTML document that lists posts (newest-first) and links to `/\u003cslug\u003e.html`.\n- Per-post pages render Markdown into `\u003carticle\u003e` and include the front-matter title + date plus a back link to `/`.\n- Pages link to `/style.css` and generation copies `static/` into `dist/` so assets resolve when served from the site root.\n\nWhere:\n- `src/site.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"Decisions + rationale:\n- Use a tiny in-code “template” (`writeDocumentStart`/`writeDocumentEnd`) rather than introducing a templating dependency for the first version.\n- Emit root-relative links (`/`, `/\u003cslug\u003e.html`, `/style.css`) to match the deployment target (root GitHub Pages URL) and keep local serving consistent.\n- Sort index entries by front-matter date (descending) with a deterministic slug tie-break.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build` generates `dist/index.html` and per-post `dist/\u003cslug\u003e.html` pages (and links to `/style.css`)\n- `zig build test`","notes":"Closure Notes\n- Outcome:\n  - `dist/index.html` and per-post `dist/\u003cslug\u003e.html` are now full HTML documents with a shared minimal template.\n  - Index lists posts newest-first and uses root-relative links.\n  - Post pages include title + date and render Markdown into an `\u003carticle\u003e`.\n  - Pages link to `/style.css`; generator copies `static/` into `dist/` so assets load at the site root.\n- Key learnings:\n  - `std.StringHashMapUnmanaged` stores slice keys; keep the backing storage alive for as long as the map needs it.\n- Decisions + rationale:\n  - Keep templating minimal and code-only for now; avoid adding a separate template/rendering layer until we have more pages.\n  - Prefer root-relative URLs because this site deploys at the domain root.\n  - Use date-desc sorting for a blog-like index.\n- Constraints / invariants discovered:\n  - `dist/` is generated output; keep `dist/.gitignore` intact.\n  - Slugs must remain unique across posts.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Files / symbols touched:\n  - `src/site.zig` (`generate`, `generatePostPage`, `writeDocumentStart`, `copyStaticAssets`)\n- External refs (PR/commit/issues): blog-0yg.5\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: writeDocumentStart, root-relative links, date-desc index sort, copyStaticAssets, slug key lifetime","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-13T12:57:59.445129-08:00","updated_at":"2025-12-13T17:18:33.874813-08:00","closed_at":"2025-12-13T17:18:33.874813-08:00","dependencies":[{"issue_id":"blog-0yg.5","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.445543-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.5","depends_on_id":"blog-0yg.3","type":"blocks","created_at":"2025-12-13T12:57:59.760605-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.5","depends_on_id":"blog-0yg.4","type":"blocks","created_at":"2025-12-13T12:57:59.792883-08:00","created_by":"daemon"}]}
{"id":"blog-0yg.6","title":"Generate RSS feed","description":"Generate an RSS 2.0 feed at `dist/feed.xml`.\n\nOutcome:\n- Site generation writes `feed.xml` with channel metadata and per-post items.\n- Item links use `base_url` + `/\u003cslug\u003e.html`; `pubDate` is emitted as RFC822 at `00:00:00 GMT`; item descriptions come from post front matter `description` when present.\n- `blog build` / `blog serve` read `site.yml` (title, description, base_url, posts/static/dist dirs) and pass those values into generation and serving.\n\nWhere:\n- `src/site.zig` (feed generation + XML escaping + RFC822 date formatting + tests)\n- `src/cli.zig` (`site.yml` parsing + wiring into build/serve + rebuild)\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","design":"Decisions + rationale:\n- Keep the feed minimal RSS 2.0 (no extra namespaces) but deterministic and valid.\n- Use `std.fs.Dir.atomicFile` for `feed.xml` writes to avoid truncation/partial reads during rebuilds.\n- Parse `site.yml` with a small, comment-aware scalar subset (consistent with the front matter needs) and fall back to safe defaults if the file is absent.\n- Since post front matter dates are `YYYY-MM-DD` only, emit `pubDate` at midnight UTC and compute weekday via a small Gregorian day-of-week function.\n- XML-escape all user-provided scalars to prevent malformed XML.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`\n- Confirm `dist/feed.xml` exists and contains absolute item links under the configured `base_url`, with RFC822 `pubDate` and front matter descriptions.","notes":"Closure Notes\n- Outcome:\n  - Added RSS 2.0 feed generation to `dist/feed.xml` (channel + per-post items).\n  - Feed items include absolute URLs (`base_url` + `/\u003cslug\u003e.html`), RFC822 `pubDate` at `00:00:00 GMT`, and optional item descriptions from front matter.\n  - `blog build` and `blog serve` now read `site.yml` and wire title/description/base_url and posts/static/dist directory names into generation + serving.\n  - Index page HTML `\u003ctitle\u003e` now uses `site.yml` title.\n- Key learnings:\n  - Zig 0.15 requires `@divTrunc/@divFloor/@divExact` for signed integer division (used in weekday calculation).\n- Decisions + rationale:\n  - Prefer atomic writes for generated artifacts so the preview server never serves partially-written XML during rebuild.\n  - Keep RSS output minimal and deterministic; avoid embedding HTML in descriptions for now.\n- Constraints / invariants discovered:\n  - `base_url` should not be assumed to have a trailing slash; generator trims it when composing item URLs.\n  - Post dates are day-granularity only; time is fixed to midnight UTC.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n  - `gh pr create ...`\n- Files / symbols touched:\n  - `src/site.zig` (RSS generation helpers + test)\n  - `src/cli.zig` (`site.yml` parsing + pass config to generator/server)\n- External refs (PR/commit/issues): blog-0yg.6; gh-8; commit 7950f6d\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: RSS 2.0 feed.xml, RFC822 pubDate, atomicFile XML, site.yml config parse","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-13T12:57:59.493752-08:00","updated_at":"2025-12-13T20:13:06.099627-08:00","closed_at":"2025-12-13T20:13:06.099627-08:00","external_ref":"gh-8","dependencies":[{"issue_id":"blog-0yg.6","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.494211-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.6","depends_on_id":"blog-0yg.4","type":"blocks","created_at":"2025-12-13T12:57:59.82382-08:00","created_by":"daemon"}]}
{"id":"blog-0yg.7","title":"Copy static assets","description":"Copy `static/` into `dist/` preserving paths.\n\nOutcome:\n- `blog build` copies `static/` into `dist/` recursively (e.g. `static/images/logo.png` -\u003e `dist/images/logo.png`).\n- `dist/style.css` is present so generated pages can link to `/style.css`.\n\nWhere:\n- `src/site.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"Decisions + rationale:\n- Copy static assets after cleaning `dist/` to ensure stale files are removed, and before writing generated pages so generator output wins on name collisions.\n- Implement a tiny recursive copy using `std.fs.Dir.iterate` + `Dir.copyFile` to avoid extra dependencies.\n- Skip `.gitignore` to avoid clobbering `dist/.gitignore` (keeps generated output out of git).","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build` copies `static/` into `dist/` (including nested paths)\n- `zig build test` (includes `site.test.generate copies static assets`)","notes":"Closure Notes\n- Outcome:\n  - Generator copies `static/` into `dist/` recursively, preserving paths.\n  - `dist/style.css` is emitted so `/style.css` links resolve.\n- Key learnings:\n  - Keeping `dist/.gitignore` intact avoids accidentally tracking generated output.\n- Decisions + rationale:\n  - Copy static before generating HTML so generated pages override any conflicting static filenames.\n  - Skip `.gitignore` during copy to preserve `dist/.gitignore`.\n- Constraints / invariants discovered:\n  - `dist/` is treated as generated output; do not clobber its `.gitignore`.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Files / symbols touched:\n  - `src/site.zig` (`copyStaticAssets`, `copyDirRecursive`)\n- External refs (PR/commit/issues): blog-0yg.7\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: copy static assets, copyDirRecursive, Dir.copyFile, dist .gitignore preserve","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T12:57:59.541468-08:00","updated_at":"2025-12-13T17:18:16.434718-08:00","closed_at":"2025-12-13T17:18:16.434718-08:00","dependencies":[{"issue_id":"blog-0yg.7","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.541888-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.7","depends_on_id":"blog-0yg.1","type":"blocks","created_at":"2025-12-13T12:57:59.855058-08:00","created_by":"daemon"}]}
{"id":"blog-0yg.8","title":"Preview server + watch/rebuild","description":"Harden local preview: `blog serve` now watches inputs and rebuilds `dist/` on change.\n\nOutcome:\n- `blog serve` rebuilds automatically on changes (polling; manual browser refresh is fine).\n- Watched paths: `posts/`, `static/`, `templates/` (if present), and `site.yml`.\n- `zig build serve -- ...` forwards args to `blog serve`.\n\nWhere:\n- `src/watch.zig`\n- `src/cli.zig`\n- `build.zig`\n- `README.md`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"Decisions + rationale:\n- Use polling (portable + simple) with a filesystem fingerprint so changes, adds, and deletes are detected without relying on platform-specific watchers.\n- Combine per-entry hashes commutatively so nondeterministic directory iteration order doesn't cause spurious rebuilds.\n- Run the watcher in a detached thread so the HTTP server stays responsive; use `std.heap.c_allocator` inside the watcher thread to avoid allocator thread-safety concerns.\n- Add `--no-watch` and `--poll-ms` for control over behavior and resource usage.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`\n- Manual: `zig build serve`, edit a file under `posts/`, `static/`, `templates/`, or `site.yml`, and observe a rebuild log + updated `dist/` output (manual browser refresh).","notes":"Closure Notes\n- Outcome:\n  - `blog serve` now starts a polling watcher that rebuilds the site into `dist/` when inputs change.\n  - Added a small filesystem fingerprint helper to detect edits/adds/deletes across `posts/`, `static/`, `templates/`, and `site.yml`.\n  - `zig build serve -- ...` now forwards args through to `blog serve`.\n- Key learnings:\n  - Zig 0.15 uses `std.Thread.sleep` (not `std.time.sleep`).\n  - `std.Thread.spawn` expects a tuple argument list (wrap single-arg structs in `.{args}`).\n- Decisions + rationale:\n  - Keep the watcher portable by polling + hashing metadata rather than using OS-specific file notification APIs.\n  - Use a commutative accumulator so rebuild decisions don’t depend on directory iteration order.\n- Constraints / invariants discovered:\n  - Only watch input trees (avoid `dist/`) so rebuilds aren’t self-triggered.\n  - Rebuild can race with serving; transient 404s during regeneration are acceptable for local preview.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Files / symbols touched:\n  - `src/watch.zig` (`fingerprint`)\n  - `src/cli.zig` (`serve` command watch flags + `watchThreadMain`)\n  - `build.zig` (forward args for `zig build serve`; add `src/watch.zig` tests)\n  - `README.md`\n- External refs (PR/commit/issues): blog-0yg.8\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: polling watcher, fingerprint hash, std.Thread.sleep, zig build serve args","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-13T12:57:59.5882-08:00","updated_at":"2025-12-13T18:29:40.791501-08:00","closed_at":"2025-12-13T18:29:00.615531-08:00","external_ref":"gh-7","dependencies":[{"issue_id":"blog-0yg.8","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.588664-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.8","depends_on_id":"blog-0yg.2","type":"blocks","created_at":"2025-12-13T12:57:59.88548-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.8","depends_on_id":"blog-0yg.5","type":"blocks","created_at":"2025-12-13T12:57:59.915693-08:00","created_by":"daemon"}]}
{"id":"blog-0yg.9","title":"CI deploy to GitHub Pages","description":"Add GitHub Actions workflow to build with Zig and deploy `dist/` to GitHub Pages (no generated files committed).\n\nOutcome:\n- Pushes to `main` (and manual dispatch) build the site and deploy the generated `dist/` directory to GitHub Pages.\n\nWhere:\n- `.github/workflows/pages.yml`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","design":"Decisions + rationale:\n- Keep deployment in a dedicated workflow so PR CI remains focused on fmt/test/build while deploy only runs for `main`.\n- Use Zig 0.15.2 via `mlugg/setup-zig` for consistency with CI.\n- Use the official GitHub Pages Actions (`actions/upload-pages-artifact` + `actions/deploy-pages`) with `pages` concurrency to serialize deployments.","acceptance_criteria":"- `.github/workflows/pages.yml` exists and deploys Pages on pushes to `main`.\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","notes":"Closure Notes\n- Outcome:\n  - Added a GitHub Actions workflow that builds the site with Zig and deploys the generated `dist/` directory to GitHub Pages (no generated files are committed).\n- Key learnings:\n  - GitHub Pages deployment via Actions is a two-job flow: build + upload artifact, then deploy.\n- Decisions + rationale:\n  - Use the official Pages actions (`actions/upload-pages-artifact` + `actions/deploy-pages`) with least-privilege token permissions.\n  - Keep deploy separate from CI so PR checks stay fast and deploy only runs on `main`.\n- Constraints / invariants discovered:\n  - `zig build` must produce `dist/index.html` for Pages to publish.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Files / symbols touched:\n  - `.github/workflows/pages.yml`\n- External refs (PR/commit/issues): blog-0yg.9\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: GitHub Pages deploy-pages upload-pages-artifact, Zig CI deploy dist","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:57:59.63395-08:00","updated_at":"2025-12-13T17:50:08.812758-08:00","closed_at":"2025-12-13T17:50:08.812758-08:00","dependencies":[{"issue_id":"blog-0yg.9","depends_on_id":"blog-0yg","type":"parent-child","created_at":"2025-12-13T12:57:59.63436-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.9","depends_on_id":"blog-0yg.2","type":"blocks","created_at":"2025-12-13T12:57:59.946029-08:00","created_by":"daemon"},{"issue_id":"blog-0yg.9","depends_on_id":"blog-0yg.5","type":"blocks","created_at":"2025-12-13T12:57:59.976817-08:00","created_by":"daemon"}]}
{"id":"blog-2dq","title":"Harden Pages deploy workflow","description":"Harden the GitHub Actions workflows for GitHub Pages deployment and CI to reduce blast radius and prevent accidental publishes.\n\nOutcome:\n- Pages deploy is restricted to `main` even for manual dispatch.\n- Pages deploy runs fmt + unit tests before publishing.\n- GITHUB_TOKEN permissions are least-privilege (Pages deploy gets `pages`/`id-token`; CI write perms only on the automerge job).\n- Runner images are pinned to reduce drift.\n\nWhere:\n- `.github/workflows/pages.yml`\n- `.github/workflows/ci.yml`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","design":"Decisions + rationale:\n- Keep Pages deployment in its own workflow (still only runs for `main`) and run fmt/tests inside that workflow so deploys are always gated.\n- Use job-level `if: github.ref == 'refs/heads/main'` to prevent `workflow_dispatch` from publishing non-`main` refs.\n- Scope permissions:\n  - default workflow perms: `contents: read`\n  - deploy job perms: `pages: write` + `id-token: write`\n  - CI automerge job perms: `contents: write` + `pull-requests: write`\n- Pin runners to `ubuntu-24.04` for stability.","acceptance_criteria":"- Pages workflow only deploys `main` (including `workflow_dispatch`).\n- Pages workflow runs `zig fmt --check`, `zig build test`, and `zig build` before uploading/deploying.\n- Pages workflow removes `dist/.gitignore` before publishing.\n- CI workflow defaults to `contents: read`; only automerge job has write permissions.\n- Runners are pinned (no `ubuntu-latest`).\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","notes":"Closure Notes\n- Outcome:\n  - Prevented accidental Pages deploys from non-`main` refs (even via manual dispatch).\n  - Gated Pages deploy on fmt + tests.\n  - Reduced GITHUB_TOKEN permissions to least-privilege for both Pages and CI.\n  - Pinned GitHub Actions runners to reduce drift.\n- Key learnings:\n  - `workflow_dispatch` can run on arbitrary refs; job-level guards are an easy hard-stop.\n  - Pages deploy uses OIDC (`id-token: write`) and should not be granted to build steps.\n- Decisions + rationale:\n  - Prefer guarding and scoping permissions over relying on UI conventions (“always run from main”).\n- Constraints / invariants discovered:\n  - Only `main` should ever be published to Pages.\n  - Deploy should only happen after fmt/tests pass for the exact commit.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Files / symbols touched:\n  - `.github/workflows/pages.yml`\n  - `.github/workflows/ci.yml`\n- External refs (PR/commit/issues): blog-2dq; PR #6\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: workflow_dispatch main guard, deploy-pages permissions, upload-pages-artifact, job-level permissions","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T18:00:31.18269-08:00","updated_at":"2025-12-13T18:02:04.935706-08:00","closed_at":"2025-12-13T18:02:04.935706-08:00","external_ref":"gh-6","labels":["invariant","security"],"dependencies":[{"issue_id":"blog-2dq","depends_on_id":"blog-0yg.9","type":"discovered-from","created_at":"2025-12-13T18:00:31.183441-08:00","created_by":"daemon"}]}
{"id":"blog-439","title":"Reject invalid UTF-8 in Markdown","description":"Reject invalid UTF-8 in Markdown rendering.\n\nOutcome:\n- Markdown rendering now validates input as UTF-8 and fails generation on invalid bytes (instead of silently replacing them).\n- Site generation logs the post filename when Markdown rendering fails.\n\nWhere:\n- `src/markdown.zig`\n- `src/site.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"Decisions + rationale:\n- Prefer fail-fast for invalid UTF-8 to avoid publishing corrupted content or hiding encoding problems.\n- Validate at the Markdown-render boundary (`renderHtmlAlloc`) so any caller gets the invariant.\n- Add a focused unit test to lock the behavior.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`\n- Invalid UTF-8 input to `src/markdown.zig` fails with `error.InvalidUtf8`.","notes":"Closure Notes\n- Outcome:\n  - Markdown rendering now rejects invalid UTF-8 instead of sanitizing it.\n  - Generation logs `posts/\u003cfile\u003e` context when rendering fails.\n- Key learnings:\n  - `std.unicode.utf8ValidateSlice` is a cheap guardrail for encoding invariants.\n- Decisions + rationale:\n  - Hard-fail is safer than silent replacement for a static site generator.\n- Constraints / invariants discovered:\n  - Posts are treated as UTF-8 text at the renderer boundary.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Files / symbols touched:\n  - `src/markdown.zig` (`renderHtmlAlloc`, invalid UTF-8 test)\n  - `src/site.zig` (log post filename on render failure)\n- External refs (PR/commit/issues): blog-439; PR #4\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: utf8ValidateSlice, invalid utf8 hard fail, markdown renderer invariant","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T16:53:44.255312-08:00","updated_at":"2025-12-13T16:54:46.891203-08:00","closed_at":"2025-12-13T16:54:46.891203-08:00","external_ref":"gh-4-utf8","labels":["invariant"],"dependencies":[{"issue_id":"blog-439","depends_on_id":"blog-7yq","type":"discovered-from","created_at":"2025-12-13T16:53:44.256097-08:00","created_by":"daemon"}]}
{"id":"blog-5oa","title":"Fix preview watch unsoundness + footguns","description":"Fix local preview watch correctness and remove footguns found in review.\n\nOutcome:\n- HTML generation now uses atomic replace, eliminating partial/truncated responses when `blog serve` rebuilds during requests.\n- Watcher startup is best-effort: failures disable watch but still serve.\n- Poll interval conversion is overflow-safe and bounded (default `--poll-ms 500`, max `60000`).\n- Watch fingerprint is more robust (includes inode/ctime; hashes small file contents up to 64KiB; symlink targets contribute).\n\nWhere:\n- `src/site.zig`\n- `src/cli.zig`\n- `src/watch.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"Decisions + rationale:\n- Prefer atomic file replacement (via `std.fs.Dir.atomicFile`) over directory swaps to keep serving stable while eliminating in-place truncation hazards.\n- Keep `blog serve` usable even if the watcher can’t start (resource limits, permissions): watcher failures become warnings.\n- Bound and checked-multiply `--poll-ms` → `ns` to prevent wraparound into a busy loop (cap: 60s).\n- Strengthen the watch fingerprint without reading all large binaries: hash content only for small files (\u003c= 64KiB); otherwise mix in inode/mtime/ctime/size.\n- Include symlink targets (up to 4096 bytes) so retargeting a watched symlink triggers rebuild.\n- Add a simple “two consecutive polls” debounce so rebuilds happen after inputs stabilize.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`\n- Manual: run `zig build serve`, edit a post while repeatedly requesting `index.html` (e.g. `curl` in a loop), and confirm responses are not truncated.","notes":"Closure Notes\n- Outcome:\n  - Removed partial-response hazards during rebuild by switching HTML generation to atomic replace.\n  - Made the watcher best-effort and prevented `--poll-ms` overflow from turning into a tight loop.\n  - Improved change detection (inode/ctime + small-file content hashing + symlink target hashing) and added a simple debounce.\n  - Defaults/limits (confirmed): `--poll-ms` default 500, max 60000; content hash cap 64KiB; symlink target cap 4096 bytes.\n- Key learnings:\n  - `std.fs.Dir.atomicFile` is a clean way to avoid in-place truncation races while serving.\n  - Fingerprinting based only on size/mtime can miss fast edits on coarse timestamp filesystems.\n- Decisions + rationale:\n  - Keep the implementation portable and dependency-free (polling + hashing), but harden the sharp edges.\n- Constraints / invariants discovered:\n  - Serving should never observe partially-written HTML files.\n  - Watch configuration must not be able to accidentally create a CPU-burning busy loop.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Files / symbols touched:\n  - `src/site.zig` (`generate` HTML writes)\n  - `src/cli.zig` (watch startup + interval bounds + debounce)\n  - `src/watch.zig` (`fingerprint` robustness)\n- External refs (PR/commit/issues): blog-5oa; discovered-from:blog-0yg.8; PR #7\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: atomicFile, partial response, poll-ms overflow, watch debounce, inode ctime fingerprint","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-13T18:46:28.633525-08:00","updated_at":"2025-12-13T19:13:24.08574-08:00","closed_at":"2025-12-13T18:51:38.295449-08:00","dependencies":[{"issue_id":"blog-5oa","depends_on_id":"blog-0yg.8","type":"discovered-from","created_at":"2025-12-13T18:46:28.634127-08:00","created_by":"daemon"}]}
{"id":"blog-7yq","title":"Harden markdown renderer invariants","description":"Harden Markdown rendering invariants and reduce footguns discovered during review.\n\nOutcome:\n- `src/markdown.zig` now registers cmark-gfm core extensions once (thread-safe) and validates UTF-8 input.\n- Removed the optional function-pointer unwrap in the free path by capturing the default allocator free function up-front.\n- Added regression tests to lock “safe by default” behavior (raw HTML + dangerous URLs scrubbed).\n- Ensured Markdown tests run under `zig build test` and that transitive test roots that import Markdown link the cmark artifacts.\n\nWhere:\n- `src/markdown.zig`\n- `src/site.zig`\n- `build.zig`\n\nVerification:\n- Update formatting: `zig fmt build.zig src/*.zig`\n- Build: `zig build`\n- Tests: `zig build test`","design":"Decisions + rationale:\n- Use `std.once` to call `cmark_gfm_core_extensions_ensure_registered()` exactly once to avoid repeated global init and reduce potential thread-safety concerns.\n- Keep renderer in safe mode (do not enable `CMARK_OPT_UNSAFE`) and add tests asserting this behavior.\n- Add `CMARK_OPT_VALIDATE_UTF8` so non-UTF8 byte sequences are handled predictably.\n- Treat `cmark_get_default_mem_allocator().free` as an invariant; capture it before rendering to avoid surprising crashes in deferred cleanup.\n\nFootguns avoided:\n- Tests that compile `src/cli.zig` transitively import `src/site.zig` (and thus `src/markdown.zig`), so those test targets must link cmark artifacts to provide headers/libs.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`\n- `src/markdown.zig` tests pass and assert safe rendering (no raw HTML / javascript: URLs)","notes":"Closure Notes\n- Outcome:\n  - Hardens Markdown rendering by making cmark extension registration one-time, validating UTF-8, and locking safety behavior with tests.\n- Key learnings:\n  - Zig test roots can compile transitive imports; if `cli.zig` imports `site.zig`, its tests also need the C include paths/libs required by `markdown.zig`.\n- Decisions + rationale:\n  - Keep cmark “safe mode” default and add a test to prevent accidental regressions (e.g., turning on `CMARK_OPT_UNSAFE`).\n- Constraints / invariants discovered:\n  - cmark core extensions must be registered before attaching extension names.\n  - cmark render output must be freed using cmark’s default allocator.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Files / symbols touched:\n  - `src/markdown.zig` (`renderHtmlAlloc`, `core_extensions_once`, safety tests)\n  - `src/site.zig` (`generatePostPage` uses renderer)\n  - `build.zig` (run tests for `src/markdown.zig`, link cmark for transitive test roots)\n- External refs (PR/commit/issues): blog-7yq; PR #4\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: std.once, cmark_gfm_core_extensions_ensure_registered, CMARK_OPT_VALIDATE_UTF8, safe mode regression test","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T16:10:16.874747-08:00","updated_at":"2025-12-13T16:13:17.728871-08:00","closed_at":"2025-12-13T16:13:17.728871-08:00","external_ref":"gh-4-followup","labels":["invariant","security"],"dependencies":[{"issue_id":"blog-7yq","depends_on_id":"blog-0yg.3","type":"discovered-from","created_at":"2025-12-13T16:10:16.875302-08:00","created_by":"daemon"}]}
{"id":"blog-7zs","title":"Harden site.yml invariants + watcher config","description":"Harden `site.yml`-driven configuration to remove destructive footguns and align watch behavior with configuration.\n\nOutcome:\n- `site.generate` now rejects unsafe output directories (empty/\".\"/absolute/contains `..`/escapes base dir) before cleaning output.\n- The preview watcher fingerprints the configured `posts_dir`/`static_dir` (and reacts to `site.yml` changes) instead of hard-coded defaults.\n- Scalar parsing helpers are deduplicated between `site.yml` and front matter parsing.\n- RSS XML writing validates UTF-8 and rejects characters outside XML 1.0 allowed ranges.\n\nWhere:\n- `src/site.zig`\n- `src/cli.zig`\n- `src/front_matter.zig`\n- `src/scalars.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","design":"Decisions + rationale:\n- Output-dir safety is enforced in `site.generate` (not just CLI) because the generator owns the deletion behavior.\n- Validate `out_dir_path` in two phases:\n  - lexical: must be relative and must not contain `..` (and must not be empty/\".\")\n  - semantic: after creation, `realpath(out_dir)` must stay within `realpath(base_dir)` and must not equal the base dir.\n- Watch behavior should follow configuration; compute the watch fingerprint from the current `site.yml` each poll so changing `posts_dir`/`static_dir` updates watch targets.\n- Avoid duplicated parsing logic by centralizing `stripInlineComment` + `parseScalar` in a small helper module.\n- RSS XML should be valid UTF-8 and contain only XML 1.0-legal characters; fail fast on invalid input rather than emitting malformed feeds.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`\n- Set `dist_dir: ..` in `site.yml` and confirm `zig build` fails without deleting files.\n- Set `posts_dir` to a non-default directory and confirm `zig build serve` rebuilds on edits under that directory.","notes":"Closure Notes\n- Outcome:\n  - Prevented path-traversal / accidental deletion by validating `out_dir_path` and ensuring the resolved output directory remains inside the base dir (and is not the base dir).\n  - Updated the watcher to fingerprint `posts_dir`/`static_dir` from `site.yml`, so configuration changes actually affect rebuild behavior.\n  - Deduped scalar parsing logic into `src/scalars.zig` and reused it from both `site.yml` parsing and front matter parsing.\n  - Made RSS XML writing reject invalid UTF-8 and XML-illegal characters.\n- Key learnings:\n  - It’s not enough to validate “relative path” lexically; symlinks require a `realpath` containment check.\n- Decisions + rationale:\n  - Put the output-dir invariant in `site.generate` because it is the layer that deletes.\n  - Recompute watch fingerprint from config each poll to avoid stale watch targets after `site.yml` edits.\n- Constraints / invariants discovered:\n  - Output directory must never be allowed to resolve to the base directory or outside it.\n  - RSS output should be valid XML (UTF-8 + legal character ranges).\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Files / symbols touched:\n  - `src/site.zig` (`validateOutDirPath`, `validateOutDirWithinBase`, XML validation)\n  - `src/cli.zig` (`fingerprintFromConfig`, watcher uses config)\n  - `src/front_matter.zig` (use `src/scalars.zig` helpers)\n  - `src/scalars.zig`\n- External refs (PR/commit/issues): blog-7zs; PR #8; commit 46ddf8a\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: out_dir traversal, realpath containment, watcher targets from config, XML 1.0 char range","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-13T20:21:42.18595-08:00","updated_at":"2025-12-13T20:26:04.332737-08:00","closed_at":"2025-12-13T20:26:04.332737-08:00","external_ref":"gh-8-review","dependencies":[{"issue_id":"blog-7zs","depends_on_id":"blog-0yg.6","type":"discovered-from","created_at":"2025-12-13T20:21:42.187657-08:00","created_by":"daemon"}]}
{"id":"blog-jc7","title":"Enable CI + auto-merge workflow","description":"Enable CI and automatic PR merging in this private repo.\n\nOutcome:\n- Added a GitHub Actions workflow that runs Zig formatting and tests.\n- Added a label-gated auto-merge step: PRs labeled `auto-merge` are squash-merged after CI passes (only for non-draft PRs targeting `main` and originating from this repo).\n- Created the `auto-merge` label and applied it to PR #3 so it will merge automatically once CI completes successfully.\n\nWhere:\n- `.github/workflows/ci.yml`\n\nVerification:\n- Local: `zig fmt build.zig src/*.zig`, `zig build`, `zig build test` (ensures CI commands succeed).\n- GitHub: PR #3 has `auto-merge` label; CI will merge it on success.","design":"- GitHub’s built-in auto-merge/branch-protection features are unavailable for this private repo on the current plan, so auto-merge is implemented via GitHub Actions.\n- Auto-merge is opt-in via an explicit `auto-merge` label to avoid surprising merges.\n- Safety checks: skip drafts, skip non-`main` targets, and skip PRs from forks.\n- Merge method is `squash` to keep `main` history linear.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`\n- PRs labeled `auto-merge` are squash-merged by CI after tests pass","notes":"Closure Notes\n- Outcome:\n  - Added CI workflow (fmt/check + build/test) and an opt-in auto-merge step gated by an `auto-merge` label.\n  - Labeled PR #3 for auto-merge.\n- Key learnings:\n  - GitHub auto-merge/branch protection is plan-gated for private repos; workflows can provide an equivalent “merge after CI passes” path.\n- Decisions + rationale:\n  - Label-gated auto-merge keeps control explicit while still removing manual merge toil.\n- Constraints / invariants discovered:\n  - Only merge PRs that are non-draft, target `main`, and originate from the same repo (not forks).\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n  - `gh pr edit 3 --add-label auto-merge`\n- Commands run (copy/paste safe):\n  - `gh label create auto-merge --description \"Merge automatically when CI passes\" --color 0E8A16`\n  - `gh pr edit 3 --add-label auto-merge`\n- Files / symbols touched:\n  - `.github/workflows/ci.yml`\n- External refs (PR/commit/issues): blog-jc7; PR #3\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: github actions auto merge label, private repo branch protection plan, zig fmt --check","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-13T15:37:07.046671-08:00","updated_at":"2025-12-13T15:39:32.330558-08:00","closed_at":"2025-12-13T15:39:32.330558-08:00","dependencies":[{"issue_id":"blog-jc7","depends_on_id":"blog-0yg.4","type":"discovered-from","created_at":"2025-12-13T15:37:07.047697-08:00","created_by":"daemon"}]}
{"id":"blog-ljd","title":"Harden preview server + generator (review follow-ups)","description":"Hardened the preview server + placeholder generator based on review findings.\n\nOutcome:\n- Serve is now bounded (no thread-per-connection) and file responses are streamed (no whole-file reads).\n- Generated HTML is deterministic and safe against HTML injection from filenames (slugified output names + HTML-escaped titles/links).\n- CLI invalid args now print usage and exit with code 2 (instead of surfacing `InvalidArgs`).\n- `zig build` no longer breaks when `-Dtarget` is non-native (the build-time tool always compiles for host; a warning is emitted).\n- `zig build test` now actually runs tests for `src/cli.zig`, `src/site.zig`, and `src/server.zig`.\n\nWhere:\n- `build.zig`\n- `src/main.zig`, `src/cli.zig`, `src/site.zig`, `src/server.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`\n- `zig build -Dtarget=x86_64-linux`","design":"- Safety over concurrency: switched the HTTP preview server to handle one connection at a time to eliminate thread/FD exhaustion from connection floods.\n- O(1) memory serving: replaced `readToEndAlloc` with `respondStreaming` and chunked file reads.\n- Stronger HTML invariants: slugify output filenames and HTML-escape all user-derived strings before emitting markup.\n- Deterministic output: sort post filenames prior to generation.\n- Build-system footgun: accept `-Dtarget` for ergonomics but warn and ignore it because the generator is a host tool.\n- Tests: run `addTest` on each module file to execute their `test {}` blocks.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build` generates `dist/index.html`\n- `zig build test` runs module tests successfully\n- `zig build -Dtarget=x86_64-linux` succeeds and prints a warning about `-Dtarget` being ignored","notes":"Closure Notes\n- Outcome: preview server no longer spawns unbounded threads and streams file responses; generator output is deterministic and HTML-safe; CLI prints usage on invalid args; build ignores non-native `-Dtarget` with a warning; `zig build test` runs real tests.\n- Key learnings: Zig 0.15 `std.ArrayList` is allocator-arg (unmanaged) by default; per-file `zig test` / `addTest` is needed to run tests in those modules.\n- Decisions + rationale: choose serial serving + streaming to remove the crash/exhaustion class with minimal complexity; enforce HTML escaping + slugging to make unsafe input inert.\n- Constraints / invariants discovered: build-time tools must run on host; user-derived HTML must be escaped; output should be deterministic for identical inputs.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n  - `zig build -Dtarget=x86_64-linux` (warns, still succeeds)\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n  - `zig build -Dtarget=x86_64-linux`\n- Files / symbols touched:\n  - `build.zig` (`test` step, host tool target)\n  - `src/main.zig` (`main` return `!u8`, leak assert)\n  - `src/cli.zig` (arg handling + test)\n  - `src/server.zig` (serial accept + streaming)\n  - `src/site.zig` (`slugify`, escaping, deterministic generation)\n- External refs (PR/commit/issues): blog-ljd; PR #2\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: respondStreaming, std.ArrayList empty append allocator, slugify html escape","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T13:52:06.84098-08:00","updated_at":"2025-12-13T14:03:12.663449-08:00","closed_at":"2025-12-13T14:03:12.663449-08:00","labels":["decision","invariant","runbook","security"],"dependencies":[{"issue_id":"blog-ljd","depends_on_id":"blog-0yg.2","type":"discovered-from","created_at":"2025-12-13T13:52:06.842749-08:00","created_by":"daemon"}]}
{"id":"blog-qcs","title":"Harden front matter parsing invariants","description":"Harden YAML front matter + generation invariants to remove unsoundness and common footguns.\n\nOutcome:\n- `front_matter.parse` now returns an owned `ParsedPost` (stores an owned `raw` buffer) so slices like `title/date/body` stay valid even if the caller frees their input.\n- `parseOwnedBuffer` supports zero-copy parsing when the caller already has an owned buffer.\n- Inline comments now work with quoted scalars (`date: \"2025-12-13\" # comment`) and are stripped from block-list tag items (`- zig # note`).\n- Dates are strictly `YYYY-MM-DD` (no trailing junk) and validated as real calendar dates.\n- Generator enforces unique slugs (duplicate slugs error instead of silently suffixing).\n- Generation errors now log the post filename for context.\n\nWhere:\n- `src/front_matter.zig`\n- `src/site.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`","design":"- Strengthened lifetime invariant: `ParsedPost` owns `raw` and all parsed slices are views into that buffer; `deinit` frees `raw` + the tags pointer list.\n- Kept a fast path: `parseOwnedBuffer` takes ownership of an already-allocated buffer (used by the generator) to avoid extra copies.\n- Chose strictness for stability:\n  - Dates must be exactly `YYYY-MM-DD` and calendar-valid.\n  - Slugs must be unique; collisions fail fast to avoid unstable URLs.\n- Diagnostics: used `std.log.warn` (not `err`) so unit tests can assert failure cases without failing on error-level logs.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build`\n- `zig build test`\n- Posts with `date: \"YYYY-MM-DD\" # comment` parse successfully\n- Duplicate `slug:` values fail generation with `error.DuplicateSlug`","notes":"Closure Notes\n- Outcome:\n  - Removed slice-lifetime footgun by making parsed posts own their backing buffer.\n  - Tightened parsing (comments/date validation) and generation invariants (unique slugs) to prevent silent bad metadata and unstable URLs.\n- Key learnings:\n  - Zig 0.15 requires `@mod/@rem` for signed remainder checks.\n  - Zig test runner treats `std.log.err` output as a test failure; prefer warn/info for diagnostic context in negative tests.\n- Decisions + rationale:\n  - Prefer owned parsing as the safe default; provide an explicit zero-copy ownership-taking API for performance.\n  - Fail on duplicate slugs instead of auto-suffixing to keep URLs stable.\n- Constraints / invariants discovered:\n  - Front matter dates are intentionally a strict `YYYY-MM-DD` subset.\n  - Every output slug must be globally unique across posts.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build`\n  - `zig build test`\n- Files / symbols touched:\n  - `src/front_matter.zig` (`ParsedPost.raw`, `parseOwnedBuffer`, `stripInlineComment`, `Date.parseIso8601`)\n  - `src/site.zig` (owned parsing + duplicate slug enforcement + diagnostics)\n- External refs (PR/commit/issues): blog-qcs; PR #3\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: use-after-free slices, owned parsed buffer, duplicate slug error, inline comment quoted scalar, YYYY-MM-DD validation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T15:12:50.825292-08:00","updated_at":"2025-12-13T15:20:15.704886-08:00","closed_at":"2025-12-13T15:20:15.704886-08:00","external_ref":"gh-3-followup","dependencies":[{"issue_id":"blog-qcs","depends_on_id":"blog-0yg.4","type":"discovered-from","created_at":"2025-12-13T15:12:50.826607-08:00","created_by":"daemon"}]}
{"id":"blog-uus","title":"Harden generator invariants (post-review)","description":"Harden site generation invariants found during review.\n\nOutcome:\n- `cleanDist` only uses `deleteTree` for real directories; symlinks (and other non-directories) are removed with `deleteFile` so cleanup can’t follow links out of `dist/`.\n- Generation validates that `static_dir_path` and `out_dir_path` do not overlap (prevents self-copy/infinite recursion and accidental deletion on misconfig).\n- Static asset copying is iterative (avoids recursion/FD blowups on deep trees).\n- Generated HTML uses relative URLs for `style.css`, `index.html`, and post pages so it works under `file://` and subpath deployments.\n- Generator warnings are gateable via `GenerateOptions.log_warnings` (tests can opt out).\n\nWhere:\n- `src/site.zig`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","design":"Decisions + rationale:\n- Validate static/output directories before mutating `dist/`:\n  - Resolve real paths and reject any prefix overlap with `error.StaticDirOverlapsOutDir`.\n  - This prevents pathological configs like `static_dir_path = \".\"` or `\"dist\"` from copying output into itself.\n- Cleanup safety: only `deleteTree` actual directories; delete everything else with `deleteFile` to avoid symlink traversal.\n- Replace recursive directory copy with an explicit stack so depth can’t overflow the call stack and dir handles aren’t held across recursion.\n- Prefer relative URLs in generated HTML to avoid hard-coding a deployment base path.\n- Keep noisy logging out of expected-failure tests via `GenerateOptions.log_warnings` while leaving CLI defaults unchanged.\n\nNew/strengthened invariants:\n- `dist/` cleanup never follows symlinks.\n- `static_dir_path` and `out_dir_path` are disjoint.","acceptance_criteria":"- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`\n- `site.test.cleanDist does not follow symlinks` passes\n- `site.test.generate rejects overlapping static and output directories` passes","notes":"Closure Notes\n- Outcome:\n  - Made `dist/` cleanup symlink-safe and added coverage.\n  - Prevented static/output overlap configs that can self-copy or delete inputs.\n  - Switched static copy to an iterative traversal (bounded stack/FD usage).\n  - Switched generated links to relative URLs for `file://` + subpath compatibility.\n  - Added `GenerateOptions.log_warnings` so expected-failure tests run clean.\n- Key learnings:\n  - `StringHashMapUnmanaged` keys are borrowed slices; explicitly owning slug keys avoids lifetime footguns.\n- Decisions + rationale:\n  - Reject overlap rather than trying to “do something reasonable” because it’s almost always a configuration error with high blast radius.\n- Constraints / invariants discovered:\n  - `dist/` is a generated tree; operations must stay confined to that tree.\n  - Static assets should be copied without recursion risk.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Files / symbols touched:\n  - `src/site.zig` (`cleanDist`, `validateStaticAndOutDirs`, `copyDirRecursive`, `GenerateOptions.log_warnings`)\n- External refs (PR/commit/issues): blog-uus\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: StaticDirOverlapsOutDir, deleteTree symlink, iterative copyDirRecursive, relative links, log_warnings","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T17:28:32.751546-08:00","updated_at":"2025-12-13T17:33:45.895649-08:00","closed_at":"2025-12-13T17:33:45.895649-08:00","labels":["invariant","security"],"dependencies":[{"issue_id":"blog-uus","depends_on_id":"blog-0yg.5","type":"discovered-from","created_at":"2025-12-13T17:28:32.75363-08:00","created_by":"daemon"}]}
{"id":"blog-w46","title":"Remove Pages workflow_dispatch","description":"Remove the manual dispatch trigger from the GitHub Pages deployment workflow so production deploys happen only on pushes to `main`.\n\nOutcome:\n- `.github/workflows/pages.yml` no longer supports `workflow_dispatch`.\n\nWhere:\n- `.github/workflows/pages.yml`\n\nVerification:\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","design":"Decisions + rationale:\n- Remove `workflow_dispatch` to eliminate the “manual deploy button” surface area; all deploys now originate from a `main` push.","acceptance_criteria":"- `.github/workflows/pages.yml` does not define `workflow_dispatch`.\n- Pages deploys only run on pushes to `main`.\n- `zig fmt build.zig src/*.zig`\n- `zig build test`\n- `zig build`","notes":"Closure Notes\n- Outcome:\n  - Removed `workflow_dispatch` from the Pages deploy workflow so deploys only happen from pushes to `main`.\n- Key learnings:\n  - Keeping deploy triggers minimal reduces accidental publish paths.\n- Decisions + rationale:\n  - Prefer “deploy via merge to main” over manual redeploys.\n- Constraints / invariants discovered:\n  - Production deploys should be tied to `main` history.\n- Verification (exact commands + results):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Commands run (copy/paste safe):\n  - `zig fmt build.zig src/*.zig`\n  - `zig build test`\n  - `zig build`\n- Files / symbols touched:\n  - `.github/workflows/pages.yml`\n- External refs (PR/commit/issues): blog-w46; PR #6\n- Follow-ups created (ids + why): None\n- Search keywords / phrases: remove workflow_dispatch pages deploy","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T18:09:27.971584-08:00","updated_at":"2025-12-13T18:10:04.85369-08:00","closed_at":"2025-12-13T18:10:04.85369-08:00","labels":["invariant","security"],"dependencies":[{"issue_id":"blog-w46","depends_on_id":"blog-2dq","type":"discovered-from","created_at":"2025-12-13T18:09:27.97241-08:00","created_by":"daemon"}]}
